# О возможном подходе к решению задачи об интеллектуальной индентификации заготовки печатной платы на рабочей области CNC станка

*Рассматривается возможный подход к решению задачи об интеллектуальной индентификации заготовки печатной платы на рабочей области CNC станка. С применением методов ....*

***Ключевые слова:*** Изготовление печатных плат, CNC станок, идентификация рабочей области, OpenCV, Canny.


**Введение.** При изготовлении печатных плат, изделие, состоящее из плоского изоляционного основания с отверстиями, пазами, вырезами и системой токопроводящих полосок металла (проводников), которое используют для установки и коммутации электрорадиоизделия (ЭРИ) и функциональных узлов в соответствии с электрической принципиальной схемой, на CNC станке одним из важных этапов является определение координат расположения заготовки. От точности определения координат заготовки зависит дальнейшее качество изготовления продукта. Так же высокая точность позволяет сделать так чтобы можно было фигачить с двух сторон, переворачивать платы как хочешь, и не портить рабочий стол при фрезеровки и сверлении сразу нафиг насквозь.

**Обзор аналогов.**Исследователи из Орхусского университета [6] разрабатывают систему ЧПУ для лазерного резака на основе комбинирования маркеров и дополненной реальности. Система основана на подходе WYSIWYG (What You See Is What You Get (англ.) — что видите, то и получаете), где проектор используется для отображения текущих контуров, а маркеры используются для установки его положения в рабочей области. Наряду с этим специалисты университета Кейо [7] расширяют функциональность фидуциальных* маркеров для лазерного резака. Чтобы установить параметры резки, они разме-
щают набор маркеров опорных точек рядом с заготовкой, в том числе метки, связанные с ма-
териалом, порядком операций и командами.
В работе [8] описан способ обнаружения ошибок контура на основе машинного зрения.
Разработан специальный измерительный прибор с нанесенными на него маркерами, который
позволяет измерять погрешность контура без сетчатого датчика.
В работе [9] предлагается метод прямой симуляции обрабатывающего инструмента
станка. Здесь маркеры используются для определения положения инструмента и заготовки;
дополненная реальность — для моделирования траектории инструмента при обработке. 

**Обзор трёхкоординатной устновки CNC-станка для производства печатных плат.** Помимо стандартных компонентов трёхкоординтной системы (шаговые двигатели, рабочий стол, инструмент), на установке (Рисунок 1) присутствуют две камеры, общего вида и уточняющая, которые являются компонентами системы технического зрения для определения координат заготовки. Камера общего вида жёстко закрепленна на основании станка, так же система может способна рабочий стол в область видимости камеры, что обеспечивает повторяемость обработки. Уточняющяя камера жестко закреплена на рабочем инструменте станка, что позволяет проводить измерения в произвольном месте рабочего стола. \\ можно и без неё но так инфы больше //

![Рисунок 1. Трёхкоординатная устновка CNC-станка для производства печатных плат](img/stanok1.jpg "Рисунок 1. Трёхкоординатная устновка CNC-станка для производства печатных плат")

Рисунок 1. Трёхкоординатная устновка CNC-станка для производства печатных плат

Все вычисления и управление шаговыми двигателями выполняются при использовании микрокомпьютера Raspberry Pi. Система разрабатывалась на языке программирования Python 3.9 при использовании библиотки OpenCV 4.1.8, для работы с техническим зрением, библиотека RPi.GPIO, для работы с универсальными портами ввода вывыдо микрокомпьютера, которые управляют механикой станка. Вышеописанные инструменты и средства разработаны продиктованы условиями Технического задания проекта.

**Алгоритм работы системы.** С учетом поставленной задачи и имеющихся средств был разработан алгоритм работы системы идентификации заготовки печатной платы (Рисунок 2).

![Рисунок 2. Алгоритм работы системы идентификации заготовки печатной платы](img/algortim.jpg "Алгоритм работы системы идентификации заготовки печатной платы")

Рисунок 2. Алгоритм работы системы идентификации заготовки печатной платы

На первом этапе происходит испарвление перспективы изабражения общего вида рабочей области. Данный этап присутствует ввиду технической несовершенности механики станка и способа закрпления камеры, что приводит к искривленному изабражению заготовки. Для исправления перспективы съемка велась таким образом, чтобы было видно больше чем рабочий стол, в графическом редакторе были получены координаты четырёх углов стола и требуемые координаты для исправления перспективы, из полученных данных можно получить матрицу преобразований, воспользовавшись функцией cv2.getPerspectiveTransform (src, dst) [OpenCV], и её применить к изображению, пропустив изображение через функцию cv2.warpPerspective (src, M, dsize)[OpenCV], которая и вернёт нам исправленное изображение. Остаётся только обрезать изображение по рабочему столу и передать полученное изображение следующим функциям системы. 

На втором этапе выполняется идентификация заготовки на изображении общего вида рабочей области. В работе [статья шефа] рассмотрено решение подобной задачи, но в условиях нашей задачи мы можем упростить работу, так как мы знаем размер искомой заготовки, заготовка проадаётся в магазине с известными параметрами. Применив функцию cv2.findContours()[OpenCV], мы получим список всех найденных на изображении контуров. Посчитав переметр каждого контура и зная периметр искомого, выбираем нужный контур и передаём координаты углов контура следующим функциям системы (Рисунок 3).

![Рисунок 3. Результат идентификации контура заготовки печатной платы по изображению с камеры общего вида](img/find_plate_perspective_out_0_525_979_737.jpg "Рисунок 3. Результат идентификации контура заготовки печатной платы по изображению с камеры общего вида")

Рисунок 3. Результат идентификации контура заготовки печатной платы по изображению с камеры общего вида

На последнем этапе имеет место выполнить уточнение координат угла заготовки печатной платы по дополнительной камере. Получив на предыдущем шаге координату угла контура, нообходимо переместить центр камеры по этой координате и получить снимок, ввиду шороховатой поверхности рабочего стола, для коректной работы дальнейших алгоритмов необходимо подложить гладкий моноцветный материал под заготовку. Последующие алгоритмы потребуют работу с изображением в двухканальном представлении, для этого применим к исходному изображению функцию cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)[OpenCV], где img - это исходное изображение, а cv2.COLOR_BGR2GRAY - требуемый цветовой фильтр. В работе [статья шефа] приведено преимущество использования метода сегментации Канни[17 ссылка в статье шефа], который мы и применим к нашему изображению, получив изображение с краями. Эту информацию необходимо отдать на обработку функции cv2.HoughLinesP [OpenCV], которая отдаст нам все линии на изображении. Далее разделим линии на две группы: те которые более горизонтальные; те которые более вертикальные. Из каждой группы необходимо методом кластеризации выбрать линюю, вокруг которой будет больше всего точек, образующее контуры, эта линии и будут образовывать вертикальный и горизонтальный край заготовки. Наконец надо определить точку пересечения этих линий - это угол платы, а так же посчитать смещение относительно центра снимка.

Далее, переместив камеру на найденное смещение, повторяем вышеописанную процедуру, пока смещение не составит меньше чем одна десятая доля миллиметра. Так же повторяем всё это с остальными углами получая уточненное значение углов заготовки (Рисунок 4). Полученные координаты передаются следующим системам управления CNC-станка.

![Рисунок 4. Результат идентификации угла заготовки печатной платы по изображению с уточняющей камеры](img/out_2_4343_rotate.jpg "Результат идентификации угла заготовки печатной платы по изображению с уточняющей камеры")

Рисунок 4. Результат идентификации угла заготовки печатной платы по изображению с уточняющей камеры. 

**Заключение.** В данной работы было рассмотрена бла бла бла бла бла
